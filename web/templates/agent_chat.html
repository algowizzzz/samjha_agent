{% extends "base.html" %}
{% block title %}Parquet Agent Chat{% endblock %}

{% block extra_css %}
<!-- Markdown CSS for better formatting -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown.min.css">
<style>
    /* Full screen layout - override all Bootstrap defaults */
    html {
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    body {
        overflow: hidden !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        display: flex !important;
        flex-direction: column !important;
        background-color: #f8f9fa !important;
    }
    /* Hide footer completely */
    footer.footer {
        display: none !important;
    }
    /* Make main container fill viewport minus navbar */
    main.container-fluid {
        margin: 0 !important;
        padding: 0 !important;
        flex: 1 !important;
        height: auto !important;
        min-height: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
        overflow: hidden !important;
    }
    /* Override Bootstrap py-4 padding class */
    main.container-fluid.py-4 {
        padding: 0 !important;
    }
    /* Override any container constraints */
    .container, .container-fluid {
        max-width: 100% !important;
        width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }
    /* Remove all margins and padding from content wrapper */
    main > div:first-child {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: 100% !important;
    }
    /* Remove card margins and ensure full width */
    .card {
        margin: 0 !important;
        margin-bottom: 0 !important;
        width: 100% !important;
        border-radius: 0 !important;
    }
    /* Remove shadow for edge-to-edge */
    .card.shadow-sm {
        box-shadow: none !important;
    }
    
    .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 100%;
        margin: 0;
        padding: 15px;
        font-size: 14px;
        background-color: white !important;
        color: #333 !important;
    }
    .markdown-body * {
        color: #333 !important;
    }
    .markdown-body pre {
        background-color: #f6f8fa;
        border-radius: 6px;
        padding: 16px;
        overflow: auto;
        color: #333 !important;
    }
    .markdown-body code {
        background-color: rgba(175, 184, 193, 0.2);
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 85%;
        color: #333 !important;
    }
    .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
        color: #333 !important;
    }
    .chat-message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 12px;
        max-width: 85%;
    }
    .chat-message.user {
        background-color: #e9ecef;
        margin-left: auto;
        text-align: right;
    }
    .chat-message.agent {
        background-color: white;
        border: 1px solid #dee2e6;
        margin-right: auto;
        color: #333;
    }
    .table-container {
        position: relative;
    }
    .table-search {
        margin-bottom: 10px;
    }
    .prompt-monitor-content {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
    }
    .prompt-monitor-content h1, .prompt-monitor-content h2, .prompt-monitor-content h3 {
        margin-top: 20px;
        margin-bottom: 10px;
        font-weight: 600;
    }
    .prompt-monitor-content code {
        background-color: #f4f4f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
    }
</style>
{% endblock %}

{% block content %}
<div class="p-0 m-0" style="height: 100%; width: 100%; display: flex; flex-direction: column; margin: 0 !important; padding: 0 !important;">
    <div class="card shadow-sm h-100 d-flex flex-column m-0" style="border-radius: 0; border: none; height: 100%; margin: 0 !important; width: 100%;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" style="flex-shrink: 0;">
            <h5 class="mb-0"><i class="bi bi-chat-text"></i> Parquet Agent</h5>
            <span class="badge bg-light text-dark">DuckDB</span>
        </div>
        <div class="card-body d-flex flex-column p-3" style="flex: 1; overflow: hidden; min-height: 0;">
            <div id="chatHistory" class="mb-3 flex-grow-1" style="overflow-y: auto; border: 1px solid #eee; padding: 12px; border-radius: 6px; background: #fafafa; min-height: 0;">
                <!-- Messages will be appended here -->
            </div>
            <div class="input-group" style="flex-shrink: 0;">
                <input id="chatInput" type="text" class="form-control" placeholder="Ask a question or follow up..." />
                <button id="sendBtn" class="btn btn-primary">
                    <i class="bi bi-send"></i> Send
                </button>
            </div>
            <div class="form-text mt-2" style="flex-shrink: 0;">Responses include an Answer, Raw Table, and Prompt Monitor summary.</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Markdown Parser -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<!-- DataTables for interactive tables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script>
    // Agent Chat v4.0 - Full screen layout, white agent bubbles - 2025-11-08
(function() {
    'use strict';
    // Ensure API token is available for /api/tools/execute
    const templateToken = "{{ session.token or '' }}";
    if (templateToken) {
        try {
            sessionStorage.setItem('mcp_token', templateToken);
            document.cookie = 'mcp_token=' + templateToken + '; path=/';
        } catch (e) {}
    }

    let sessionId = localStorage.getItem('agent_session_id') || '';
    if (!sessionId) {
        sessionId = 'sess-' + Math.random().toString(36).slice(2, 10);
        localStorage.setItem('agent_session_id', sessionId);
    }

    const historyEl = document.getElementById('chatHistory');
    const inputEl = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    function escapeHtml(str) {
        if (!str) return '';
        // Convert to string first (handles objects, numbers, etc)
        const text = (typeof str === 'string') ? str : String(str);
        return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function formatTable(rawTable, tableId) {
        if (!rawTable || !rawTable.columns || !rawTable.rows) {
            return 'No table data available';
        }
        
        const maxRows = 1000; // DataTables can handle more rows
        const displayRows = rawTable.rows.slice(0, maxRows);
        
        let html = '<div class="table-container">';
        html += '<div class="table-search"><input type="text" class="form-control form-control-sm" id="search_' + tableId + '" placeholder="Search table..."></div>';
        html += '<div class="table-responsive"><table id="table_' + tableId + '" class="table table-sm table-striped table-bordered table-hover" style="width:100%">';
        
        // Header
        html += '<thead><tr>';
        rawTable.columns.forEach(col => {
            html += '<th>' + escapeHtml(col) + '</th>';
        });
        html += '</tr></thead>';
        
        // Rows
        html += '<tbody>';
        displayRows.forEach(row => {
            html += '<tr>';
            rawTable.columns.forEach(col => {
                const value = row[col] !== undefined ? row[col] : '';
                html += '<td>' + escapeHtml(String(value)) + '</td>';
            });
            html += '</tr>';
        });
        html += '</tbody>';
        
        html += '</table></div>';
        
        if (rawTable.row_count > maxRows) {
            html += '<div class="small text-muted mt-2">Showing first ' + maxRows + ' of ' + rawTable.row_count + ' rows</div>';
        } else {
            html += '<div class="small text-muted mt-2">Total: ' + rawTable.row_count + ' rows</div>';
        }
        
        html += '</div>';
        
        // Initialize DataTable after HTML is inserted
        setTimeout(function() {
            if ($.fn.DataTable && $('#table_' + tableId).length) {
                try {
                    const tableConfig = {
                        pageLength: 25,
                        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                        order: [],
                        responsive: true,
                        scrollX: true
                    };
                    
                    // Add buttons if available
                    if ($.fn.dataTable.Buttons) {
                        tableConfig.dom = 'Bfrtip';
                        tableConfig.buttons = ['copy', 'csv'];
                    }
                    
                    const table = $('#table_' + tableId).DataTable(tableConfig);
                    
                    // Add search functionality
                    $('#search_' + tableId).on('keyup', function() {
                        table.search(this.value).draw();
                    });
                } catch (e) {
                    console.error('DataTable initialization error:', e);
                }
            }
        }, 200);
        
        return html;
    }

    let messageCounter = 0;
    
    function appendMessage(role, text, finalOutput) {
        messageCounter++;
        const wrapper = document.createElement('div');
        wrapper.className = 'mb-3';
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message ' + role;
        
        const roleBadge = role === 'user' ? '<span class="badge bg-secondary me-2">You</span>' : '<span class="badge bg-success me-2">Agent</span>';
        
        // Render markdown for agent responses, plain text for user
        let contentHtml = '';
        if (role === 'agent' && typeof marked !== 'undefined') {
            try {
                // Render markdown
                const markdownHtml = marked.parse(text);
                contentHtml = '<div class="markdown-body">' + markdownHtml + '</div>';
            } catch (e) {
                console.error('Markdown rendering error:', e);
                contentHtml = '<div>' + escapeHtml(text) + '</div>';
            }
        } else {
            contentHtml = '<div>' + escapeHtml(text) + '</div>';
        }
        
        messageDiv.innerHTML = roleBadge + contentHtml;
        wrapper.appendChild(messageDiv);
        
        if (finalOutput && typeof finalOutput === 'object') {
            // Extract final_output if it exists
            const output = finalOutput.final_output || finalOutput;
            const tableId = 'table_' + messageCounter;
            
            // Raw Table (collapsible, collapsed by default)
            if (output.raw_table) {
                const tableDetails = document.createElement('details');
                tableDetails.className = 'mt-2';
                tableDetails.innerHTML = '<summary class="small text-info" style="cursor:pointer;"><i class="bi bi-table"></i> Raw Table (' + (output.raw_table.row_count || 0) + ' rows)</summary>';
                
                const tableContent = document.createElement('div');
                tableContent.className = 'mt-2 p-2 bg-light border rounded';
                tableContent.style.maxHeight = '600px';
                tableContent.style.overflowY = 'auto';
                tableContent.innerHTML = formatTable(output.raw_table, tableId);
                
                tableDetails.appendChild(tableContent);
                wrapper.appendChild(tableDetails);
            }
            
            // Prompt Monitor (collapsible, collapsed by default)
            if (output.prompt_monitor) {
                const monitorDetails = document.createElement('details');
                monitorDetails.className = 'mt-2';
                
                let monitorText = '';
                let isMarkdown = false;
                
                if (typeof output.prompt_monitor === 'object') {
                    // If it has procedural_reasoning (LLM-generated), show that
                    if (output.prompt_monitor.procedural_reasoning) {
                        monitorText = output.prompt_monitor.procedural_reasoning;
                        isMarkdown = true;
                    } else {
                        // Otherwise show the full object as JSON
                        monitorText = JSON.stringify(output.prompt_monitor, null, 2);
                    }
                } else {
                    monitorText = String(output.prompt_monitor);
                }
                
                monitorDetails.innerHTML = '<summary class="small text-primary" style="cursor:pointer;"><i class="bi bi-lightbulb"></i> Prompt Monitor' + (isMarkdown ? ' (LLM Reasoning)' : '') + '</summary>';
                
                const monitorContent = document.createElement('div');
                monitorContent.className = 'mt-2 p-3 bg-light border rounded prompt-monitor-content';
                monitorContent.style.maxHeight = '500px';
                monitorContent.style.overflowY = 'auto';
                
                if (isMarkdown && typeof marked !== 'undefined') {
                    try {
                        monitorContent.innerHTML = marked.parse(monitorText);
                    } catch (e) {
                        console.error('Markdown rendering error:', e);
                        monitorContent.innerHTML = '<pre class="small">' + escapeHtml(monitorText) + '</pre>';
                    }
                } else {
                    monitorContent.innerHTML = '<pre class="small text-muted">' + escapeHtml(monitorText) + '</pre>';
                }
                
                monitorDetails.appendChild(monitorContent);
                wrapper.appendChild(monitorDetails);
            }
        }
        
        historyEl.appendChild(wrapper);
        historyEl.scrollTop = historyEl.scrollHeight;
    }

    let awaitingClarification = false;
    let currentSessionId = sessionId;

    function sendQuery() {
        const q = inputEl.value.trim();
        if (!q) return;
        appendMessage('user', q);
        inputEl.value = '';
        $('#sendBtn').prop('disabled', true);

        const requestArgs = {
            query: q,
            session_id: currentSessionId,
            user_id: '{{ user.user_id | default("anonymous") }}'
        };

        // If we're responding to a clarification request, add user_clarification
        if (awaitingClarification) {
            requestArgs.user_clarification = q;
            awaitingClarification = false;
            inputEl.placeholder = 'Ask a question or provide a follow-up...';
        }

        API.post('/api/tools/execute', {
            tool: 'parquet_agent',
            arguments: requestArgs
        }).done(function(resp) {
            console.log('API Response:', resp);
            const result = (resp && resp.result) ? resp.result : resp;
            console.log('Result:', result);
            
            // Update session ID if provided
            if (result.session_id) {
                currentSessionId = result.session_id;
                localStorage.setItem('agentSessionId', currentSessionId);
            }
            
            // Check if agent needs clarification
            if (result.control === 'wait_for_user' && result.clarify_prompt) {
                // Agent is asking for clarification
                console.log('Clarification needed:', result.clarify_prompt);
                appendMessage('agent', result.clarify_prompt);
                awaitingClarification = true;
                inputEl.placeholder = 'Provide clarification...';
            } else {
                // Normal response
                const finalOut = (result && result.final_output) ? result.final_output : {};
                const answer = finalOut.response || JSON.stringify(result).slice(0, 1000);
                console.log('Answer:', answer);
                console.log('Final Output:', finalOut);
                
                // Pass result (contains final_output with raw_table, response, prompt_monitor)
                appendMessage('agent', answer, result);
                awaitingClarification = false;
                inputEl.placeholder = 'Ask a question or provide a follow-up...';
            }
        }).fail(function(xhr) {
            const err = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : ('HTTP ' + xhr.status);
            appendMessage('agent', 'Error: ' + err);
            awaitingClarification = false;
            inputEl.placeholder = 'Ask a question or provide a follow-up...';
        }).always(function() {
            $('#sendBtn').prop('disabled', false);
        });
    }

    sendBtn.addEventListener('click', sendQuery);
    inputEl.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') sendQuery();
    });
})();
</script>
{% endblock %}


